<!DOCTYPE html>
<html class=no-js lang=fr itemscope itemtype=http://schema.org/Organization>
    <head>
        <meta http-equiv=X-UA-Compatible content="IE=edge">
        <meta charset=utf-8>
        <title>Installer votre dépot privé Docker</title>
        <meta property=fb:app_id content=432735746865877>
        <meta property=og:url content=http://code-troopers.com/2015/06/25/InstallDockerRegistry.html>
        <meta property=og:title content="Installer votre dépot privé Docker">
        <meta property=twitter:card content=summary>
        <meta property=twitter:site content=codetroopers>
        <meta property=twitter:image:src content=http://code-troopers.com/images/banner/docker-banner.png>
        <meta property=og:image content=http://code-troopers.com/images/banner/docker-banner.png>
        <meta property=twitter:title content="Installer votre dépot privé Docker">
        <meta property=twitter:creator content=@codetroopers>
        <meta property=twitter:domain content=http://code-troopers.com>
        
        
        <meta property=twitter:description content="Petit à petit chez Code-Troopers, nous migrons tous nos développements pour utiliser Docker. Cela fait quelque temps que nous l’utilisons...">
        
        
        
        <meta name=description content="Petit à petit chez Code-Troopers, nous migrons tous nos développements pour utiliser Docker. Cela fait quelque temps que nous l’utilisons pour des projets “public”, auquel cas le registry public Docker est largement suffisant (et immédiat à utiliser). En revanche, nous commençons à migrer nos applications de production également vers Docker, et nous ne pouvons pas utiliser le mode public du registry public. Nous nous sommes donc mis à déployer un dépôt privé, authentifié par utilisateur / mot de passe. La procédure n’est pas très complexe, mais cette opération reste une bonne opportunité d’écrire un article à ce sujet (les articles en français n’étant pas légion). Step by step Il faut créer une entrée DNS pour votre service. Puis nous allons utiliser l’image Docker avec nginx pour l’authentification docker-nginx-registry-proxy. Informations d’identification Pour les étapes suivantes, placez vous dans le répertoire de votre choix pour stocker les fichiers (dans ce cas nous sommes dans /srv/registry-config) Génération du certificat Pensez à bien renseigner le FQDN DNS lors de la demande de Common Name pour le certificat. openssl genrsa -out ca.key 4096 openssl req -new -x509 -days 1826 -key ca.key -out ca.crt openssl genrsa -out ia.key 4096 openssl req -new -key key.pem -out ia.csr...">
        <meta property=og:description content="Petit à petit chez Code-Troopers, nous migrons tous nos développements pour utiliser Docker. Cela fait quelque temps que nous l’utilisons pour des projets “public”, auquel cas le registry public Docker est largement suffisant (et immédiat à utiliser). En revanche, nous commençons à migrer nos applications de production également vers Docker, et nous ne pouvons pas utiliser le mode public du registry public. Nous nous sommes donc mis à déployer un dépôt privé, authentifié par utilisateur / mot de passe. La procédure n’est pas très complexe, mais cette opération reste une bonne opportunité d’écrire un article à ce sujet (les articles en français n’étant pas légion). Step by step Il faut créer une entrée DNS pour votre service. Puis nous allons utiliser l’image Docker avec nginx pour l’authentification docker-nginx-registry-proxy. Informations d’identification Pour les étapes suivantes, placez vous dans le répertoire de votre choix pour stocker les fichiers (dans ce cas nous sommes dans /srv/registry-config) Génération du certificat Pensez à bien renseigner le FQDN DNS lors de la demande de Common Name pour le certificat. openssl genrsa -out ca.key 4096 openssl req -new -x509 -days 1826 -key ca.key -out ca.crt openssl genrsa -out ia.key 4096 openssl req -new -key key.pem -out ia.csr...">
        
        <meta name=viewport content="width=device-width">

        <link rel=stylesheet href=/styles/2e03639a.main.css>

        <!--[if lt IE 9]><script src="/scripts/1d7b502c.ie8.js"></script><![endif]-->
        <meta itemprop=name content=CT-CDGT>
        <meta itemprop=name content=CT-RMLC>
        <meta itemprop=name content=CT-BNCS>
        <meta itemprop=name content=CT-JRPT>
        <meta itemprop=name content=CT-MTBL>
        <meta itemprop=name content=CT-FLCH>
        <meta itemprop=name content=CT-VCMB>
    </head>
    <body>
        
        <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NWLQD2" height=0 width=0 style=display:none;visibility:hidden></iframe></noscript>
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-NWLQD2');</script>
        
        <!--[if lt IE 8]><p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a
                href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p><![endif]-->

<header data-spy=affix class=affix-top>
    <div class=container>
        <div class=navbar-header itemscope itemtype=http://schema.org/Organization>
            <button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse>
                <span><i class="fa fa-bars fa-2x"></i></span>
            </button>
            <a class=navbar-brand href="/"><img itemprop=logo class=logo alt="Code-Troopers logo" title="Code-Troopers logo" src=/images/logo.png>
                <span itemprop=name class=brand>Code-Troopers</span>
            </a>
        </div>
        <nav class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li class=active><a data-scrolltolink=aboutUs>À propos</a></li>
                <li><a data-scrolltolink=projects>Réalisations</a></li>
                <li><a data-scrolltolink=skills>Compétences</a></li>
                <li><a data-scrolltolink=team>L'équipe</a></li>
                <li><a data-scrolltolink=contact>Contact</a></li>
                <li><a href=/blog/index.html>Blog</a></li>
            </ul>
        </nav>
        
    </div>
</header>

    <section id=post>
        <div class=header>
            <div class=container><a href=/blog/index.html>Le <span>blog</span></a></div>
        </div>
        <div class=container>
        <article>
            <div>
		<div class=cover style=background-image:url(/images/banner/docker-banner-big.png)>
                    <div class=date>posté le 25/06/2015 par Cedric</div>
                </div>
                <h2><a href=/2015/06/25/InstallDockerRegistry.html>Installer votre dépot privé Docker</a></h2>
                <ul class=tags>
                    
                    <li>guide</li>
                    
                    <li>docker</li>
                    
                    <li>tips</li>
                    
                </ul>
                <div class=content>
                    <p>Petit à petit chez Code-Troopers, nous migrons tous nos développements pour utiliser Docker. 
Cela fait quelque temps que nous l’utilisons pour des projets “public”, auquel cas le registry public Docker est largement suffisant (et immédiat à utiliser).</p>

<p>En revanche, nous commençons à migrer nos applications de production également vers Docker, et nous ne pouvons pas utiliser le mode public du registry public.
Nous nous sommes donc mis à déployer un dépôt privé, authentifié par utilisateur / mot de passe. </p>

<p>La procédure n’est pas très complexe, mais cette opération reste une bonne opportunité d’écrire un article à ce sujet (les articles en français n’étant pas légion).
</p>

<h2 id=step-by-step>Step by step</h2>
<p>Il faut créer une entrée DNS pour votre service.</p>

<p>Puis nous allons utiliser l’image Docker avec nginx pour l’authentification <a href=https://github.com/MarvAmBass/docker-nginx-registry-proxy>docker-nginx-registry-proxy</a>.</p>

<h2 id=informations-didentification>Informations d’identification</h2>
<p>Pour les étapes suivantes, placez vous dans le répertoire de votre choix pour stocker les fichiers (dans ce cas nous sommes dans <code>/srv/registry-config</code>)</p>

<h3 id=gnration-du-certificat>Génération du certificat</h3>
<p>Pensez à bien renseigner le FQDN DNS lors de la demande de Common Name pour le certificat.</p>

<pre><code>openssl genrsa -out ca.key 4096
openssl req -new -x509 -days 1826 -key ca.key -out ca.crt
openssl genrsa -out ia.key 4096
openssl req -new -key key.pem -out ia.csr #this is where you need to fill your FQDN
openssl x509 -req -days 730 -in ia.csr -CA ca.crt -CAkey ca.key -set_serial 01 -out cert.pem
</code></pre>

<h3 id=gnration-des-mots-de-passes-basic-auth>Génération des mots de passes basic auth</h3>
<p>En utilisant un container docker qui embarque htpasswd vous pourrez générer facilement le fichier nécessaire : </p>

<pre><code>docker run --rm -ti -v $(pwd):/tmp dgageot/htpasswd -c /tmp/docker-registry.htpasswd $MONUSER
</code></pre>

<h2 id=dmarrage-du-registry>Démarrage du registry</h2>
<p>Les images seront stockées dans le répertoire <code>/srv/registry</code></p>

<pre><code>mkdir /srv/registry
docker run -d --restart=always --name registry -v /srv/docker-registry:/registry -e "SETTINGS_FLAVOR=local" -e "STORAGE_PATH=/registry" registry
docker run -d --restart=always -p 443:443 -v /srv/registry-config:/etc/nginx/external --link registry:registry --name nginx-registry-proxy marvambass/nginx-registry-proxy
</code></pre>

<h2 id=configuration-dune-machine-cliente>Configuration d’une machine cliente</h2>

<h3 id=importer-le-certificat-racine>Importer le certificat racine</h3>
<p>Il faut importer le certificat racine dans la liste des certificats reconnus</p>

<pre><code>sudo -s
mkdir -p /etc/docker/certs.d/$FQDN
cp ca.crt /etc/docker/certs.d/$FQDN/

mkdir -p /usr/local/share/ca-certificates/docker-ct
cp ca.crt /usr/local/share/ca-certificates/docker-ct/
update-ca-certificates-
</code></pre>

<p>Pour vérifier que tout fonctionne comme attendu, vous pouvez voir si votre certificat ressort bien dans la commande suivante : </p>

<pre><code>awk -v cmd='openssl x509 -noout -subject' ' /BEGIN/{close(cmd)};{print | cmd}' &lt; /etc/ssl/certs/ca-certificates.crt | grep $(VOTRE IDENTIFIANT)
</code></pre>

<p>Vous serez également certainement amené à redémarrer vos daemon docker (de chacune des machines)</p>

<pre><code>systemctl stop docker
systemctl start docker
</code></pre>

<h3 id=identification-sur-le-dpot>Identification sur le dépot</h3>
<p>Une fois que toutes ces étapes sont effectuées, normalement votre dépot est prêt à être utilisé. </p>

<p>Il vous faut cependant en première étape vous identifier à l’aide du couple utilisateur / mot de passe créé lors de l’installation : </p>

<pre><code>docker login https://mondepotdocker.tld
</code></pre>

<p>Ceci aura pour effet de créer un fichier <code>~/.dockercfg</code> vous permettant d’accéder aux commandes suivantes sans avoir besoin de retaper vos identifiants.</p>

<h2 id=utilisation-du-dpt>Utilisation du dépôt</h2>

<p>Une fois la machine cliente configurée, vous pouvez simplement utiliser le dépot en préfixant les noms de vos images par l’URL du dépôt.
Par exemple, pour push/pull l’image de monapplication la commande suivante fera l’affaire :</p>

<pre><code>docker push mondepotdocker.tld/monapplication:v1.0.0
docker pull mondepotdocker.tld/monapplication:v1.0.0
</code></pre>

<h3 id=utilisation-avec-docker-compose>Utilisation avec docker-compose</h3>

<p>Si vous utilisez docker-compose, il se peut que vous ayiez des soucis avec le certificat autosigné et/ou avec l’authentification.</p>

<p>Pour contourner la vérification du certificat, vous pouvez simplement lancer <code>docker-compose</code> avec le flag <code>--allow-insecure-ssl</code>.</p>

<p>Pour ce qui est de l’authentification, une astuce simple pour contourner les problèmes de ce genre est de faire un <code>docker pull</code> manuellement au préalable (le scripter depuis le fichier compose.yml n’est pas trop difficile).</p>

                </div>
<div class=share>
L'article vous a plu ? Partagez-le :
    <ul class=socials>
        <li>
            <a target=_blank title=Twitter href="https://twitter.com/share?url=http://code-troopers.com/2015/06/25/InstallDockerRegistry.html&text=Installer votre dépot privé Docker&via=codetroopers" rel=nofollow onclick="window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false">
                <i class="fa fa-twitter-square"></i>
            </a>
        </li>
        <li>
            <a target=_blank title=Facebook href="https://www.facebook.com/sharer.php?u=http://code-troopers.com/2015/06/25/InstallDockerRegistry.html&t=Installer votre dépot privé Docker" class=facebook-button rel=nofollow onclick="window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false">
                <i class="fa fa-facebook-square"></i>
            </a>
        </li>
        <li>
            <a target=_blank title="Google +" href="https://plus.google.com/share?url=http://code-troopers.com/2015/06/25/InstallDockerRegistry.html&hl=fr" class=google-button rel=nofollow onclick="window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false">
                <i class="fa fa-google-plus-square"></i>
            </a>
        </li>
        <li>
            <a target=_blank title=Linkedin href="https://www.linkedin.com/shareArticle?mini=true&url=http://code-troopers.com/2015/06/25/InstallDockerRegistry.html&title=Installer votre dépot privé Docker" class=linkedin-button rel=nofollow onclick="window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false">
                <i class="fa fa-linkedin-square"></i>
            </a>
        </li>
        <li>
            <a target=_blank title="Envoyer par mail" href="mailto:?subject=Installer votre dépot privé Docker&body=http://code-troopers.com/2015/06/25/InstallDockerRegistry.html" rel=nofollow>
                <i class="fa fa-envelope"></i>
            </a>
        </li>
    </ul>
</div>
<div style=clear:both></div>



                <div class=back>
                    <a href=/blog/index.html><i class="fa fa-arrow-circle-o-up"></i> Retour aux articles</a>
                    <div class="pull-right paginate">
                        
                        <a href=/2015/06/10/CompletionJavascriptDansIntelliJ.html><i class="fa fa-arrow-circle-o-left"></i> Précédent</a>
                        
                        
                        <span class=disabled><i class="fa fa-arrow-circle-o-right"></i> Suivant</span>
                        
                    </div>
                </div>
                <div id=disqus_thread></div>
                <script type=text/javascript>
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'codetroopers'; // required: replace example with your forum shortname
		    var disqus_url = window.location.href;
		    if (window.location.protocol != "http:"){
			disqus_url = "http:" + window.location.href.substring(window.location.protocol.length);
		    }

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
                <a href=http://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>

            </div>
        </article>
        </div>
    </section>
<footer id=contact>
    <div class=container>
        <div class=row>
            <div class=col-md-6 itemscope itemtype=http://schema.org/Organization>
                <h3>Contact</h3>

                <p>Vous avez besoin de nous pour un projet, contactez-nous sur les réseaux sociaux, par mail à <a href=mailto:contact@code-troopers.com><meta itemprop=email content=contact@code-troopers.com>contact@code-
                    troopers.com</a> ou par téléphone au <a href=tel:+33782287216><span itemprop=telephone>0782 287 216</span></a></p>
            </div>
            <div class="col-md-6 simple-social-icons">
                <h3>Réseaux sociaux</h3>
                <ul class=socials>
                    <li><a target=_blank href=https://twitter.com/codetroopers><i class="fa fa-twitter-square"></i></a></li>
                    <li><a target=_blank href=https://www.facebook.com/pages/Code-Troopers/123604307824664><i class="fa fa-facebook-square"></i></a></li>
                    <li><a target=_blank href=https://plus.google.com/+Code-troopers rel=publisher><i class="fa fa-google-plus-square"></i></a></li>
                    <li><a target=_blank href=https://github.com/code-troopers><i class="fa fa-github-square"></i></a></li>
                    <li><a target=_blank href=/feed.xml><i class="fa fa-rss-square"></i></a></li>
                </ul>
            </div>
        </div>
        <div class=row>
            <div class=footer-under>
                Made with <i class="fa fa-heart"></i> in Tours -
                © 2014 - 2015 Code-Troopers - Tous droits réservés
            </div>
        </div>
    </div>
</footer>

<script src=//ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js></script>

<script src=/scripts/aa413edf.plugins.js></script>

<script src=/scripts/32bd55f7.scripts.js></script>

</body>
</html>