<!DOCTYPE html>
<html class=no-js>
    <head>
        <meta http-equiv=X-UA-Compatible content="IE=edge">
        <meta charset=utf-8>
        <title>Résoudre les conflits de dépendances</title>
        <meta name=description content="Code-Troopers est une équipe de développeurs située à Tours, réalisant des projets aux environs de la Touraine et sur la région parisienne.">
        <meta name=viewport content="width=device-width">
        <meta http-equiv=content-language content=fr-FR>

        <link rel=stylesheet href=/styles/d9b10959.main.css>

        <!--[if lt IE 9]><script src="/scripts/7b95c9a5.ie8.js"></script><![endif]-->
    </head>
    <body>
        <!--[if lt IE 8]><p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a
                href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p><![endif]-->

<header data-spy=affix class=affix-top>
    <div class=container>
        <div class=navbar-header>
            <button type=button class=navbar-toggle data-toggle=collapse data-target=.navbar-collapse>
                <span><i class="fa fa-bars fa-2x"></i></span>
            </button>
            <a class=navbar-brand href="/"><img itemprop=image class=logo alt="Code-Troopers logo" title="Code-Troopers logo" src=/images/logo.png><span itemprop=name class=brand>Code-Troopers</span></a>
        </div>
        <nav class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li class=active><a data-scrolltolink=aboutUs>À propos</a></li>
                <li><a data-scrolltolink=skills>Compétences</a></li>
                <li><a data-scrolltolink=projects>Réalisations</a></li>
                <li><a data-scrolltolink=team>L'équipe</a></li>
                <li><a data-scrolltolink=contact>Contact</a></li>
                <li><a href=/blog/index.html>Blog</a></li>
            </ul>
        </nav>
        
    </div>
</header>

    <section id=post>
        <div class=header>
            <div class=container><a href=/blog/index.html>Le <span>blog</span></a></div>
        </div>
        <div class=container>
        <article>
            <div>
		<div class=cover style=background-image:url(/images/banner/maven-banner-big.png)>
                    <div class=date>posté le 01/09/2014 par Cedric</div>
                </div>
                <h2><a href=/2014/09/01/ConflitsDependances.html>Résoudre les conflits de dépendances</a>
                    <ul class=tags>
                        
                        <li>Maven</li>
                        
                        <li>Dependances</li>
                        
                        <li>Tips</li>
                        
                    </ul>
                </h2>
                <div class=content>
                    <p>Lors de nos développements, nous reposons beaucoup sur des projets externes qui nous fournissent énormément de services utiles. Dans un récent projet, nous avons eu besoin de faire fonctionner Neo4j conjointement à ElasticSearch. Jusqu’ici, aucun soucis n’est à déplorer, mais nous avions une exigeance particulière : il fallait que l’application puisse démarrer automatiquement un serveur Neo4J ainsi qu’un serveur ElasticSearch sur les postes de développements (ainsi que pour les tests d’intégration).</p>

<h2 id=problme_existant>Problème existant</h2>

<p>Les deux outils que nous utilisons se basent sur Apache Lucene pour toute la partie indexation et accès aux données. Mais, et c’est là que le problème se situe, ils n’utilisent pas les mêmes versions de Lucene.</p>

<pre><code>&lt;!-- Extrait du pom d'ElasticSearch --&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;
    &lt;artifactId&gt;lucene-core&lt;/artifactId&gt;
    &lt;version&gt;4.9.0&lt;/version&gt;
    &lt;scope&gt;compile&lt;/scope&gt;
&lt;/dependency&gt;</code></pre>
<hr>
<pre><code>&lt;!-- Extrait du pom de Neo4j --&gt; 
&lt;dependency&gt;
    &lt;groupId&gt;org.apache.lucene&lt;/groupId&gt;
    &lt;artifactId&gt;lucene-core&lt;/artifactId&gt;
    &lt;version&gt;3.6.2&lt;/version&gt;
&lt;/dependency&gt;</code></pre>

<p>ElasticSearch utilise la version 4.9.0, alors que Neo4J utilise la version 3.6.2. Ainsi, en fonction du bon vouloir du <code>Classloader</code> qui sera utilisé par l’application, il se peut qu’ElasticSearch ou Neo4J refuse de fonctionner. La difficulté pour comprendre et détecter le problème est qu’il se manifeste souvent par un obscur <code>NoClassDefFoundError</code> ou <code>NoSuchMethodError</code> qui n’est pas des plus explicites (d’autant plus lorsque notre IDE nous montre une version qui contient ledit symbole non trouvé).</p>

<h2 id=solution_de_contournement>Solution de contournement</h2>

<p>Le conflit est assez simple à contourner une fois qu’on a compris ce qui se passe. En fait, il y a deux classes portant le même nom dans les classes chargées, par exemple <code>org.lucene.MaClass</code>, l’une effaçant l’autre aux yeux du <code>ClassLoader</code>. Une pratique courante est de renommer (ou relocate) le package de base d’une bibliothèque utilisée et de l’inclure dans le fichier de package du projet, le plugin <code>maven-shade</code> est conçu dans cette optique. Le choix fait est de renommer la dépendance Lucene dans Neo4J pour notre part, ainsi, nous avons forké le projet et configuré le plugin <code>shade</code> pour qu’il inclue le contenu de la dépendance d’Apache Lucene et qu’il fasse le renommage de <code>org.apache.lucene</code> en <code>shaded.org.apache.lucene</code>.</p>

<pre><code> &lt;plugin&gt;
        &lt;groupId&gt;org.apache.maven.plugins&lt;/groupId&gt;
        &lt;artifactId&gt;maven-shade-plugin&lt;/artifactId&gt;
        &lt;version&gt;2.2&lt;/version&gt;
        &lt;executions&gt;
            &lt;execution&gt;
                &lt;phase&gt;package&lt;/phase&gt;
                &lt;goals&gt;
                    &lt;goal&gt;shade&lt;/goal&gt;
                &lt;/goals&gt;
                &lt;configuration&gt;
                    &lt;createDependencyReducedPom&gt;true&lt;/createDependencyReducedPom&gt;

                    &lt;artifactSet&gt;
                        &lt;includes&gt;
                            &lt;include&gt;org.apache.lucene:*&lt;/include&gt;
                        &lt;/includes&gt;
                    &lt;/artifactSet&gt;
                    &lt;relocations&gt;
                        &lt;relocation&gt;
                            &lt;pattern&gt;org.apache.lucene&lt;/pattern&gt;
                            &lt;shadedPattern&gt;shaded.org.apache.lucene&lt;/shadedPattern&gt;
                        &lt;/relocation&gt;
                    &lt;/relocations&gt;
                &lt;/configuration&gt;
            &lt;/execution&gt;
        &lt;/executions&gt;
  &lt;/plugin&gt;</code></pre>

<h2 id=dploiement_et_nommage>Déploiement et nommage</h2>

<p>Pour ne pas polluer les dépôts, le numéro de version modifié a été postfixé par <code>-shaded</code>. Le déploiement a été fait sur un dépôt Maven qui est en fait un simple repository Github. Le commit correspondant à cette modification <a href=https://github.com/CedricGatay/neo4j/commit/452f58fca69ffe3b1d0eab6261b8342f8da95889>est consultable ici</a>.</p>
                </div>
<div class=share>
L'article vous a plu ? Partagez-le :
    <ul class=socials>
        <li>
            <a target=_blank title=Twitter href="https://twitter.com/share?url=http://code-troopers.com/2014/09/01/ConflitsDependances.html&text=Résoudre les conflits de dépendances&via=codetroopers" rel=nofollow onclick="window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false">
                <i class="fa fa-twitter-square"></i>
            </a>
        </li>
        <li>
            <a target=_blank title=Facebook href="https://www.facebook.com/sharer.php?u=http://code-troopers.com/2014/09/01/ConflitsDependances.html&t=Résoudre les conflits de dépendances" class=facebook-button rel=nofollow onclick="window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false">
                <i class="fa fa-facebook-square"></i>
            </a>
        </li>
        <li>
            <a target=_blank title="Google +" href="https://plus.google.com/share?url=http://code-troopers.com/2014/09/01/ConflitsDependances.html&hl=fr" class=google-button rel=nofollow onclick="window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false">
                <i class="fa fa-google-plus-square"></i>
            </a>
        </li>
        <li>
            <a target=_blank title=Linkedin href="https://www.linkedin.com/shareArticle?mini=true&url=http://code-troopers.com/2014/09/01/ConflitsDependances.html&title=Résoudre les conflits de dépendances" class=linkedin-button rel=nofollow onclick="window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false">
                <i class="fa fa-linkedin-square"></i>
            </a>
        </li>
        <li>
            <a target=_blank title="Envoyer par mail" href="mailto:?subject=Résoudre les conflits de dépendances&body=http://code-troopers.com/2014/09/01/ConflitsDependances.html" rel=nofollow>
                <i class="fa fa-envelope"></i>
            </a>
        </li>
    </ul>
</div>
<div style=clear:both></div>



                <div class=back>
                    <a href=/blog/index.html><i class="fa fa-arrow-circle-o-up"></i> Retour aux articles</a>
                    <div class="pull-right paginate">
                        
                        <a href=/2014/08/08/ElCurator.html><i class="fa fa-arrow-circle-o-left"></i> Précédent</a>
                        
                        
                        <span class=disabled><i class="fa fa-arrow-circle-o-right"></i> Suivant</span>
                        
                    </div>
                </div>
                <div id=disqus_thread></div>
                <script type=text/javascript>
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'codetroopers'; // required: replace example with your forum shortname

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href=http://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript>
                <a href=http://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a>

            </div>
        </article>
        </div>
    </section>
<footer id=contact>
    <div class=container>
        <div class=row>
            <div class=col-md-6>
                <h3>Contact</h3>

                <p>Vous avez besoin de nous pour un projet, contactez-nous sur les réseaux sociaux, par mail à <a href=mailto:contact@code-troopers.com><meta itemprop=email content=contact@code-troopers.com>contact@code-
                    troopers.com</a> ou par téléphone au <a href=tel:+33782287216><span itemprop=telephone>0782 287 216</span></a></p>
            </div>
            <div class="col-md-6 simple-social-icons">
                <h3>Réseaux sociaux</h3>
                <ul class=socials>
                    <li><a target=_blank href=https://twitter.com/codetroopers><i class="fa fa-twitter-square"></i></a></li>
                    <li><a target=_blank href=https://www.facebook.com/pages/Code-Troopers/123604307824664><i class="fa fa-facebook-square"></i></a></li>
                    <li><a target=_blank href=https://plus.google.com/+Code-troopers rel=publisher><i class="fa fa-google-plus-square"></i></a></li>
                    <li><a target=_blank href=https://github.com/code-troopers><i class="fa fa-github-square"></i></a></li>
                    <li><a target=_blank href=/feed.xml><i class="fa fa-rss-square"></i></a></li>
                </ul>
            </div>
        </div>
        <div class=row>
            <div class=footer-under>
                Made with <i class="fa fa-heart"></i> in Tours -
                © 2014 Code-Troopers - Tous droits réservés
            </div>
        </div>
    </div>
</footer>

<script>
    (function (i, s, o, g, r, a, m) {
        i['GoogleAnalyticsObject'] = r;
        i[r] = i[r] || function () {
            (i[r].q = i[r].q || []).push(arguments)
        }, i[r].l = 1 * new Date();
        a = s.createElement(o),
                m = s.getElementsByTagName(o)[0];
        a.async = 1;
        a.src = g;
        m.parentNode.insertBefore(a, m)
    })(window, document, 'script', '//www.google-analytics.com/analytics.js', 'ga');

    ga('create', 'UA-39705299-1', 'code-troopers.com');
    ga('send', 'pageview');
</script>

<script src=//ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js></script>

<script src=/scripts/229ace39.plugins.js></script>

<script src=/scripts/32bd55f7.scripts.js></script>

</body>
</html>