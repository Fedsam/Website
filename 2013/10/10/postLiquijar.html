<!doctype html >
<html class="no-js" lang="fr" itemscope itemtype="http://schema.org/Organization">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta charset="utf-8">
        <title>Customisation de liquibase</title>
        <meta property="fb:app_id" content="432735746865877"/>
        <meta property="og:url" content="http://code-troopers.com/2013/10/10/postLiquijar.html"/>
        <meta property="og:title" content="Customisation de liquibase"/>
        <meta property="twitter:card" content="summary"/>
        <meta property="twitter:site" content="codetroopers"/>
        <meta property="twitter:image:src" content="http://code-troopers.com/images/banner/liquibase-banner.png"/>
        <meta property="og:image" content="http://code-troopers.com/images/banner/liquibase-banner.png"/>
        <meta property="twitter:title" content="Customisation de liquibase"/>
        <meta property="twitter:creator" content="@codetroopers"/>
        <meta property="twitter:domain" content="http://code-troopers.com"/>
        
        
        <meta property="twitter:description" content="Préambule Liquibase est une bibliothèque qui permet de gérer et d&#39;appliquer des changements dans une base de données. Introduction Comme...">
        
        
        
        <meta name="description" content="Préambule Liquibase est une bibliothèque qui permet de gérer et d&#39;appliquer des changements dans une base de données. Introduction Comme de nombreuses équipes, nous utilisons liquibase pour gérer les modifications à apporter aux bases de données, que ce soit sur les postes de développeur ou bien sur les machines de production. Nous nous sommes cependant confrontés à certaines limitations de liquibase. Nous avons donc apporté quelques améliorations. Lancer des .jar, correspondant à la migration de données. Ne pas lancer un ChangeSet avant une date prédéfinie. Lancer un ChangeSet sur certaines machines selon leur hostname. Que Faire Premièrement, vous avez besoin de créer une classe java qui réalisera le test à exécuter avant le lancement. Dans notre cas, nous voulions tester la présence d&#39;un fichier de migration, la date courante ou le nom de la machine. Si celui-ci échoue les classes java lèvent une exception qui est interceptée par Liquibase dans le ChangeSet. Vous avez juste besoin de dire à Liquibase ce qu&#39;il doit faire, par exemple s&#39;arrêter ou continuer et exécuter les autres ChangeSet. Un exemple concret Dans votre fichier xml, voici ce que vous devriez avoir 1 2 3 4 5 6 7 8&lt;changeSet id=&quot;&quot; author=&quot;&quot;&gt; &lt;preConditions onFail=&quot;CONTINUE&quot;&gt; &lt;customPrecondition..." />
        <meta property="og:description" content="Préambule Liquibase est une bibliothèque qui permet de gérer et d&#39;appliquer des changements dans une base de données. Introduction Comme de nombreuses équipes, nous utilisons liquibase pour gérer les modifications à apporter aux bases de données, que ce soit sur les postes de développeur ou bien sur les machines de production. Nous nous sommes cependant confrontés à certaines limitations de liquibase. Nous avons donc apporté quelques améliorations. Lancer des .jar, correspondant à la migration de données. Ne pas lancer un ChangeSet avant une date prédéfinie. Lancer un ChangeSet sur certaines machines selon leur hostname. Que Faire Premièrement, vous avez besoin de créer une classe java qui réalisera le test à exécuter avant le lancement. Dans notre cas, nous voulions tester la présence d&#39;un fichier de migration, la date courante ou le nom de la machine. Si celui-ci échoue les classes java lèvent une exception qui est interceptée par Liquibase dans le ChangeSet. Vous avez juste besoin de dire à Liquibase ce qu&#39;il doit faire, par exemple s&#39;arrêter ou continuer et exécuter les autres ChangeSet. Un exemple concret Dans votre fichier xml, voici ce que vous devriez avoir 1 2 3 4 5 6 7 8&lt;changeSet id=&quot;&quot; author=&quot;&quot;&gt; &lt;preConditions onFail=&quot;CONTINUE&quot;&gt; &lt;customPrecondition...">
        
        <meta name="viewport" content="width=device-width">

        <link rel="stylesheet" href="/styles/style-320a49db9b-320a49db9b.css">
     
        <!--[if lt IE 9]>
                <script src="/js/ie8-0a07727802-0a07727802.js"></script>           
        <![endif]-->
        <meta itemprop="name" content="CT-CDGT"/>
        <meta itemprop="name" content="CT-RMLC"/>
        <meta itemprop="name" content="CT-BNCS"/>
        <meta itemprop="name" content="CT-JRPT"/>
        <meta itemprop="name" content="CT-MTBL"/>
        <meta itemprop="name" content="CT-FLCH"/>
        <meta itemprop="name" content="CT-VCMB"/>
    </head>
    <body>
        <!-- Google Tag Manager -->
        <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NWLQD2"
                height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-NWLQD2');</script>
        <!-- End Google Tag Manager -->
        <!--[if lt IE 8]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a
                href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

<header data-spy="affix" class="affix-top">
    <div class="container">
        <div class="navbar-header" itemscope itemtype="http://schema.org/Organization">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span><i class="fa fa-bars fa-2x"></i></span>
            </button>
            <a class="navbar-brand" href="/"><img itemprop="logo" class="logo" alt="Code-Troopers logo" title="Code-Troopers logo" src="/images/logo_noel.png">
                <span itemprop="name" class="brand">Code-Troopers</span>
            </a>
        </div>
        <nav class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li class="active"><a data-scrollToLink="aboutUs">À propos</a></li>
                <li><a data-scrollToLink="projects">Réalisations</a></li>
                <li><a data-scrollToLink="skills">Compétences</a></li>
                <li><a data-scrollToLink="team">L'équipe</a></li>
                <li><a data-scrollToLink="contact">Contact</a></li>
                <li><a href="/blog/index.html">Blog</a></li>
            </ul>
        </nav>
        <!--/.nav-collapse -->
    </div>
</header>

    <section id="post">
        <div class="header">
            <div class="container"><a href="/blog/index.html">Le <span>blog</a></span></div>
        </div>
        <div class="container">
        <article>
            <div>
		<div class="cover" style="background-image:url(/images/banner/liquibase-banner-big.png)">
                    <div class="date">posté le 10/10/2013 par Mattboll</div>
                </div>
                <h2><a href="/2013/10/10/postLiquijar.html">Customisation de liquibase</a></h2>
                <ul class="tags">
                    
                    <li>liquibase</li>
                    
                    <li>technique</li>
                    
                </ul>
                <div class="content">
                    <h3>Préambule</h3>
<p><a href="http://www.liquibase.org/">Liquibase</a> est une bibliothèque qui permet de gérer et d'appliquer des changements dans une base de données.</p>

<h3>Introduction</h3>
<p>
    Comme de nombreuses équipes, nous
    utilisons liquibase pour gérer les modifications à apporter aux bases de données, que ce soit sur les postes de
    développeur ou bien sur les machines de production.

    Nous nous sommes cependant confrontés à certaines limitations de liquibase. Nous avons donc apporté quelques
    améliorations.
<ul>
    <li>Lancer des .jar, correspondant à la migration de données.</li>
    <li>Ne pas lancer un ChangeSet avant une date prédéfinie.</li>
    <li>Lancer un ChangeSet sur certaines machines selon leur hostname.</li>
</ul>
</p>
<!--more-->

<br/>
<h3>Que Faire</h3>
<p>
    Premièrement, vous avez besoin de créer une classe java qui réalisera le test à exécuter avant le lancement. Dans
    notre cas, nous voulions tester la présence d'un fichier de migration, la date courante ou le nom de la machine.
    <br>Si celui-ci échoue les classes java lèvent une exception qui est interceptée par Liquibase dans le ChangeSet.
    Vous avez juste besoin de dire à Liquibase ce qu'il doit faire, par exemple s'arrêter ou continuer et exécuter les
    autres ChangeSet.</br>
</p>
<br/>
<h3>Un exemple concret</h3>
<p>Dans votre fichier xml, voici ce que vous devriez avoir</p>
<br><figure class="highlight"><pre><code class="language-xml" data-lang="xml"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8</pre></td><td class="code"><pre><span class="nt">&lt;changeSet</span> <span class="na">id=</span><span class="s">""</span> <span class="na">author=</span><span class="s">""</span><span class="nt">&gt;</span>
    <span class="nt">&lt;preConditions</span> <span class="na">onFail=</span><span class="s">"CONTINUE"</span><span class="nt">&gt;</span>
	<span class="nt">&lt;customPrecondition</span> <span class="na">className=</span><span class="s">"com.srmvision.liquibase.check.PreconditionTimeLiquijar"</span><span class="nt">&gt;</span>
	    <span class="nt">&lt;param</span> <span class="na">name=</span><span class="s">"dateAndHourBeforeRun"</span> <span class="na">value=</span><span class="s">"10-09-2013 15:32"</span><span class="nt">/&gt;</span>
	<span class="nt">&lt;/customPrecondition&gt;</span>
    <span class="nt">&lt;/preConditions&gt;</span>
    VOTRE COMMANDE ICI
<span class="nt">&lt;/changeSet&gt;</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>
</br>
<p><br>Cela indique que vous allez lancer la classe PreconditionTimeLiquijar avant d'exécuter votre ChangeSet. Si la
       condition échoue, le ChangeSet ne sera pas exécuté cette fois et il sera testé à nouveau au prochain lancement de
       Liquibase.</br></p>
<br/>
<p>La classe associée ressemble à ceci :</p>
<br>
<div class="codestyle">
    <figure class="highlight"><pre><code class="language-java" data-lang="java"><table style="border-spacing: 0"><tbody><tr><td class="gutter gl" style="text-align: right"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49</pre></td><td class="code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">PreconditionTimeLiquijar</span> <span class="kd">implements</span> <span class="n">CustomPrecondition</span> <span class="o">{</span>


    <span class="kd">private</span> <span class="n">String</span> <span class="n">dateBeforeRun</span> <span class="o">;</span>
    <span class="kd">private</span> <span class="n">String</span> <span class="n">dateAndHourBeforeRun</span><span class="o">;</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="n">check</span><span class="o">(</span><span class="kd">final</span> <span class="n">Database</span> <span class="n">database</span><span class="o">)</span>
	    <span class="kd">throws</span> <span class="n">CustomPreconditionFailedException</span> <span class="o">{</span>
	<span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">dateBeforeRun</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">dateAndHourBeforeRun</span><span class="o">)){</span>
	    <span class="n">SimpleDateFormat</span> <span class="n">format</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">"dd-MM-yyyy"</span><span class="o">);</span>
	    <span class="n">ParsePosition</span> <span class="n">pos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ParsePosition</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
	    <span class="n">Calendar</span> <span class="n">time</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
	    <span class="n">Date</span> <span class="n">date</span> <span class="o">;</span>
	    <span class="n">date</span> <span class="o">=</span> <span class="n">format</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">dateBeforeRun</span><span class="o">,</span><span class="n">pos</span><span class="o">);</span>
	    <span class="k">if</span> <span class="o">(</span><span class="n">time</span><span class="o">.</span><span class="na">getTime</span><span class="o">().</span><span class="na">before</span><span class="o">(</span><span class="n">date</span><span class="o">)){</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">CustomPreconditionFailedException</span><span class="o">(</span><span class="s">"Try to launch before executed date asked!"</span><span class="o">);</span>
	    <span class="o">}</span>
	<span class="o">}</span> <span class="k">else</span> <span class="k">if</span> <span class="o">(</span><span class="n">StringUtils</span><span class="o">.</span><span class="na">isNotBlank</span><span class="o">(</span><span class="n">dateAndHourBeforeRun</span><span class="o">)</span> <span class="o">&amp;&amp;</span> <span class="n">StringUtils</span><span class="o">.</span><span class="na">isBlank</span><span class="o">(</span><span class="n">dateBeforeRun</span><span class="o">)){</span>
	    <span class="n">SimpleDateFormat</span> <span class="n">format</span> <span class="o">=</span> <span class="k">new</span> <span class="n">SimpleDateFormat</span><span class="o">(</span><span class="s">"dd-MM-yyyy HH:mm"</span><span class="o">);</span>
	    <span class="n">ParsePosition</span> <span class="n">pos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ParsePosition</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span>
	    <span class="n">Calendar</span> <span class="n">time</span> <span class="o">=</span> <span class="n">Calendar</span><span class="o">.</span><span class="na">getInstance</span><span class="o">();</span>
	    <span class="n">Date</span> <span class="n">date</span> <span class="o">;</span>
	    <span class="n">date</span> <span class="o">=</span> <span class="n">format</span><span class="o">.</span><span class="na">parse</span><span class="o">(</span><span class="n">dateAndHourBeforeRun</span><span class="o">,</span><span class="n">pos</span><span class="o">);</span>
	    <span class="k">if</span> <span class="o">(</span><span class="n">time</span><span class="o">.</span><span class="na">getTime</span><span class="o">().</span><span class="na">before</span><span class="o">(</span><span class="n">date</span><span class="o">)){</span>
		<span class="k">throw</span> <span class="k">new</span> <span class="n">CustomPreconditionFailedException</span><span class="o">(</span><span class="s">"Try to launch before executed date and hour asked!"</span><span class="o">);</span>
	    <span class="o">}</span>
	<span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
	    <span class="k">throw</span> <span class="k">new</span> <span class="n">CustomPreconditionFailedException</span><span class="o">(</span><span class="s">"You can't specify both of the arguments, please remove one"</span><span class="o">);</span>
	<span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="n">String</span> <span class="n">getDateBeforeRun</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">dateBeforeRun</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setDateBeforeRun</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">dateBeforeRun</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">this</span><span class="o">.</span><span class="na">dateBeforeRun</span> <span class="o">=</span> <span class="n">dateBeforeRun</span><span class="o">;</span>
    <span class="o">}</span>


    <span class="kd">public</span> <span class="n">String</span> <span class="n">getDateAndHourBeforeRun</span><span class="o">()</span> <span class="o">{</span>
	<span class="k">return</span> <span class="n">dateAndHourBeforeRun</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="n">setDateAndHourBeforeRun</span><span class="o">(</span><span class="kd">final</span> <span class="n">String</span> <span class="n">dateAndHourBeforeRun</span><span class="o">)</span> <span class="o">{</span>
	<span class="k">this</span><span class="o">.</span><span class="na">dateAndHourBeforeRun</span> <span class="o">=</span> <span class="n">dateAndHourBeforeRun</span><span class="o">;</span>
    <span class="o">}</span>
<span class="o">}</span><span class="w">
</span></pre></td></tr></tbody></table></code></pre></figure>
</div>
</br>
<p>
    <br>Le nom du paramètre dans le ChangeSet doit correspondre au nom de l'attribut de la classe java.</br>
    <br>Ici, nous avons deux attributs, mais nous ne pouvons en instancier qu'un seul (selon l'utilisation d'un date ou
	d'un datetime). Comme vous pouvez le voir, avec notre pré-condition nous sommes dans le deuxième bloc if (ligne
	19). À ce stade, il s'agit simplement de code java pour parser la date et la comparer à la date du jour. Si
	celle-ci est antérieure à aujourd'hui, cela signifie que le ChangeSet doit être exécuté, donc nous ne faisons
	rien dans la classe java. Sinon nous devons lancer une exception qui va être attrapée et traitée par
	Liquibase.<br>
</p>

                </div>
<div class="share">
L'article vous a plu ? Partagez-le :
    <ul class="socials">
        <li>
            <a target="_blank" title="Twitter" href="https://twitter.com/share?url=http://code-troopers.com/2013/10/10/postLiquijar.html&text=Customisation de liquibase&via=codetroopers" 
                rel="nofollow" 
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;">
                <i class="fa fa-twitter-square"></i>
            </a>
        </li>
        <li>
            <a target="_blank" title="Facebook" href="https://www.facebook.com/sharer.php?u=http://code-troopers.com/2013/10/10/postLiquijar.html&t=Customisation de liquibase" 
                class="facebook-button" rel="nofollow" 
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;">
                <i class="fa fa-facebook-square"></i>
            </a>
        </li>
        <li>
            <a target="_blank" title="Google +" href="https://plus.google.com/share?url=http://code-troopers.com/2013/10/10/postLiquijar.html&hl=fr" 
                class="google-button" rel="nofollow" 
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;">
                <i class="fa fa-google-plus-square"></i>
            </a>
        </li>
        <li>
            <a target="_blank" title="Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http://code-troopers.com/2013/10/10/postLiquijar.html&title=Customisation de liquibase" 
                class="linkedin-button" rel="nofollow" 
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;">
                <i class="fa fa-linkedin-square"></i>
            </a>
        </li>
        <li>
            <a target="_blank" title="Envoyer par mail" href="mailto:?subject=Customisation de liquibase&body=http://code-troopers.com/2013/10/10/postLiquijar.html" rel="nofollow">
                <i class="fa fa-envelope"></i>
            </a>
        </li>
    </ul>
</div>
<div style="clear:both"></div>



                <div class="back">
                    <a href="/blog/index.html"><i class="fa fa-arrow-circle-o-up"></i> Retour aux articles</a>
                    <div class="pull-right paginate">
                        
                        <a href="/2013/07/08/postJsTrac.html"><i class="fa fa-arrow-circle-o-left"></i> Précédent</a>
                        
                        
                        <a href="/2014/01/01/CestReparti.html"><i class="fa fa-arrow-circle-o-right"></i> Suivant</a>
                        
                    </div>
                </div>
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'codetroopers'; // required: replace example with your forum shortname
		    var disqus_url = window.location.href;
		    if (window.location.protocol != "http:"){
			disqus_url = "http:" + window.location.href.substring(window.location.protocol.length);
		    }

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            </div>
        </article>
        </div>
    </section>
<footer id="contact">
    <div class="container">
        <div class="row">
            <div class="col-md-6" itemscope itemtype="http://schema.org/Organization">
                <h3>Contact</h3>

                <p>Vous avez besoin de nous pour un projet, contactez-nous sur les réseaux sociaux, par mail à <a
                    href="mailto:contact@code-troopers.com"><meta itemprop="email" content="contact@code-troopers.com">contact@code-
                    troopers.com</a> ou par téléphone au <a href="tel:+33782287216"><span itemprop="telephone">0782 287 216</span></a></p>
            </div>
            <div class="col-md-6 simple-social-icons">
                <h3>Réseaux sociaux</h3>
                <ul class="socials">
                    <li><a target="_blank" href="https://twitter.com/codetroopers"><i
                            class="fa fa-twitter-square"></i></a></li>
                    <li><a target="_blank"
                           href="https://www.facebook.com/pages/Code-Troopers/123604307824664"><i
                            class="fa fa-facebook-square"></i></a></li>
                    <li><a target="_blank" href="https://plus.google.com/+Code-troopers" rel="publisher"><i
                            class="fa fa-google-plus-square"></i></a></li>
                    <li><a target="_blank" href="https://github.com/code-troopers"><i
                            class="fa fa-github-square"></i></a></li>
                    <li><a target="_blank" href="/feed.xml"><i
                            class="fa fa-rss-square"></i></a></li>
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="footer-under">
                Made with <i class="fa fa-heart"></i> in Tours -
                © 2014 - 2015 Code-Troopers - Tous droits réservés
            </div>
        </div>
    </div>
</footer>

<script src="/js/scripts-a074f2f8cd-a074f2f8cd.js"></script>

</body>
</html>



