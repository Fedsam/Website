<!doctype html >
<html class="no-js" lang="fr" itemscope itemtype="http://schema.org/Organization">
    <head>
        <meta http-equiv="X-UA-Compatible" content="IE=edge">
        <meta charset="utf-8">
        <title>Jenkins Workflow Plugin</title>
        <meta property="fb:app_id" content="432735746865877"/>
        <meta property="og:url" content="http://code-troopers.com/2016/01/20/JenkinsWorkflow.html"/>
        <meta property="og:title" content="Jenkins Workflow Plugin"/>
        <meta property="twitter:card" content="summary"/>
        <meta property="twitter:site" content="codetroopers"/>
        <meta property="twitter:image:src" content="http://code-troopers.com/images/banner/jenkins-banner.png"/>
        <meta property="og:image" content="http://code-troopers.com/images/banner/jenkins-banner.png"/>
        <meta property="twitter:title" content="Jenkins Workflow Plugin"/>
        <meta property="twitter:creator" content="@codetroopers"/>
        <meta property="twitter:domain" content="http://code-troopers.com"/>
        
        
        <meta property="twitter:description" content="Un des points génants lors de l&#8217;utilisation de Jenkins est le coté volatile de la configuration des jobs de builds....">
        
        
        
        <meta name="description" content="Un des points génants lors de l&#8217;utilisation de Jenkins est le coté volatile de la configuration des jobs de builds. Il est souvent nécessaire de jouer de click-click pour faire la configuration des jobs sur Jenkins et de se reposer sur un plugin permettant de versionner, autant que possible, les configurations utilisées. Mais, une fois que vous aurez lu cet article, vous vous rendrez compte que c&#8217;est le passé. Attention toutefois, cet article parle de Jenkins, de Docker et de Groovy, n&#8217;ayez pas peur, tout est presque trop simple&#8230;&#8203; Prérequis Jenkins Jenkins avec accès à Docker Nous avons l&#8217;habitude d&#8217;utiliser un Jenkins lancé dans un container depuis quelques temps. Nous utilisons l&#8217;image maintenue par Michael Bitard agileek/docker-jenkins. Nous lançons cette image en lui fournissant de quoi exécuter le binaire docker client sans soucis : docker run -d --restart=&quot;always&quot; --name jenkins -u $(id -u):$(getent group docker | cut -d: -f3) (1) -p 8080:8080 -v /var/jenkins_home:/var/jenkins_home (2) -v $(which docker):/usr/bin/docker (3) -v /var/run/docker.sock:/var/run/docker.sock (4) -v /usr/lib/x86_64-linux-gnu/libapparmor.so.1:/lib/x86_64-linux-gnu/libapparmor.so.1 (5) agileek/docker-jenkins (6) 1 Le container est lancé avec l&#8217;utilisateur courant et le groupe docker pour pouvoir accéder au docker.sock 2 Pour éviter les incohérences de chemin, le chemin racine du jenkins est le même en..." />
        <meta property="og:description" content="Un des points génants lors de l&#8217;utilisation de Jenkins est le coté volatile de la configuration des jobs de builds. Il est souvent nécessaire de jouer de click-click pour faire la configuration des jobs sur Jenkins et de se reposer sur un plugin permettant de versionner, autant que possible, les configurations utilisées. Mais, une fois que vous aurez lu cet article, vous vous rendrez compte que c&#8217;est le passé. Attention toutefois, cet article parle de Jenkins, de Docker et de Groovy, n&#8217;ayez pas peur, tout est presque trop simple&#8230;&#8203; Prérequis Jenkins Jenkins avec accès à Docker Nous avons l&#8217;habitude d&#8217;utiliser un Jenkins lancé dans un container depuis quelques temps. Nous utilisons l&#8217;image maintenue par Michael Bitard agileek/docker-jenkins. Nous lançons cette image en lui fournissant de quoi exécuter le binaire docker client sans soucis : docker run -d --restart=&quot;always&quot; --name jenkins -u $(id -u):$(getent group docker | cut -d: -f3) (1) -p 8080:8080 -v /var/jenkins_home:/var/jenkins_home (2) -v $(which docker):/usr/bin/docker (3) -v /var/run/docker.sock:/var/run/docker.sock (4) -v /usr/lib/x86_64-linux-gnu/libapparmor.so.1:/lib/x86_64-linux-gnu/libapparmor.so.1 (5) agileek/docker-jenkins (6) 1 Le container est lancé avec l&#8217;utilisateur courant et le groupe docker pour pouvoir accéder au docker.sock 2 Pour éviter les incohérences de chemin, le chemin racine du jenkins est le même en...">
        
        <meta name="viewport" content="width=device-width">

        <link rel="stylesheet" href="/styles/style-3159a04bcb.css">

        <!--[if lt IE 9]>
                <script src="/js/ie8-0a07727802.js"></script>
        <![endif]-->
        <meta itemprop="name" content="CT-CDGT"/>
        <meta itemprop="name" content="CT-RMLC"/>
        <meta itemprop="name" content="CT-BNCS"/>
        <meta itemprop="name" content="CT-JRPT"/>
        <meta itemprop="name" content="CT-MTBL"/>
        <meta itemprop="name" content="CT-FLCH"/>
        <meta itemprop="name" content="CT-VCMB"/>
    </head>
    <body>
        <!-- Google Tag Manager -->
        <noscript><iframe src="//www.googletagmanager.com/ns.html?id=GTM-NWLQD2"
                height="0" width="0" style="display:none;visibility:hidden"></iframe></noscript>
        <script>(function(w,d,s,l,i){w[l]=w[l]||[];w[l].push({'gtm.start':
new Date().getTime(),event:'gtm.js'});var f=d.getElementsByTagName(s)[0],
            j=d.createElement(s),dl=l!='dataLayer'?'&l='+l:'';j.async=true;j.src=
                '//www.googletagmanager.com/gtm.js?id='+i+dl;f.parentNode.insertBefore(j,f);
        })(window,document,'script','dataLayer','GTM-NWLQD2');</script>
        <!-- End Google Tag Manager -->
        <!--[if lt IE 8]>
        <p class="browsehappy">You are using an <strong>outdated</strong> browser. Please <a
                href="http://browsehappy.com/">upgrade your browser</a> to improve your experience.</p>
        <![endif]-->

<header data-spy="affix" class="affix-top">
    <div class="container">
        <div class="navbar-header" itemscope itemtype="http://schema.org/Organization">
            <button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
                <span><i class="fa fa-bars fa-2x"></i></span>
            </button>
            <a itemprop="url" class="navbar-brand" href="/"><img itemprop="logo" class="logo" alt="Code-Troopers logo" title="Code-Troopers logo" src="/images/logo.png">
                <span itemprop="name" class="brand">Code-Troopers</span>
            </a>
        </div>
        <nav class="navbar-collapse collapse">
            <ul class="nav navbar-nav navbar-right">
                <li class="active"><a data-scrollToLink="aboutUs">À propos</a></li>
                <li><a data-scrollToLink="projects">Réalisations</a></li>
                <li><a data-scrollToLink="skills">Compétences</a></li>
                <li><a data-scrollToLink="team">L'équipe</a></li>
                <li><a data-scrollToLink="contact">Contact</a></li>
                <li><a href="/blog/index.html">Blog</a></li>
            </ul>
        </nav>
        <!--/.nav-collapse -->
    </div>
</header>

    <section id="post">
        <div class="header">
            <div class="container"><a href="/blog/index.html">Le <span>blog</a></span></div>
        </div>
        <div class="container">
        <article>
            <div>
		<div class="cover" style="background-image:url(/images/banner/jenkins-banner-big.png)">
                    <div class="date">posté le 20/01/2016 par Cedric</div>
                </div>
                <h2><a href="/2016/01/20/JenkinsWorkflow.html">Jenkins Workflow Plugin</a></h2>
                <ul class="tags">
                    
                    <li>Jenkins</li>
                    
                    <li>Docker</li>
                    
                </ul>
                <div class="content">
                    <div class="paragraph">
<p>Un des points génants lors de l&#8217;utilisation de Jenkins est le coté volatile de la configuration des jobs de builds.
Il est souvent nécessaire de jouer de click-click pour faire la configuration des jobs sur Jenkins et de se reposer sur un plugin permettant de versionner,
autant que possible, les configurations utilisées.</p>
</div>
<div class="paragraph">
<p>Mais, une fois que vous aurez lu cet article, vous vous rendrez compte que c&#8217;est le passé.
Attention toutefois, cet article parle de Jenkins, de Docker et de Groovy, n&#8217;ayez pas peur, tout est <em>presque</em> trop simple&#8230;&#8203;</p>
</div>
<div class="paragraph">
<p><!--break--></p>
</div>
<div class="sect1">
<h2 id="prérequis-jenkins">Prérequis Jenkins</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="jenkins-avec-accès-à-docker">Jenkins avec accès à Docker</h3>
<div class="paragraph">
<p>Nous avons l&#8217;habitude d&#8217;utiliser un Jenkins lancé dans un container depuis quelques temps.</p>
</div>
<div class="paragraph">
<p>Nous utilisons l&#8217;image maintenue par <a href="https://agileek.github.io/">Michael Bitard</a> <a href="https://hub.docker.com/r/agileek/docker-jenkins/"><code>agileek/docker-jenkins</code></a>.</p>
</div>
<div class="paragraph">
<p>Nous lançons cette image en lui fournissant de quoi exécuter le binaire docker client sans soucis :</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="bash">docker run
       -d --restart<span class="tok-o">=</span><span class="tok-s2">&quot;always&quot;</span> --name jenkins
       -u <span class="tok-k">$(</span>id -u<span class="tok-k">)</span>:<span class="tok-k">$(</span>getent group docker <span class="tok-p">|</span> cut -d: -f3<span class="tok-k">)</span> <i class="conum" data-value="1"></i><b>(1)</b>
       -p 8080:8080
       -v /var/jenkins_home:/var/jenkins_home <i class="conum" data-value="2"></i><b>(2)</b>
       -v <span class="tok-k">$(</span>which docker<span class="tok-k">)</span>:/usr/bin/docker <i class="conum" data-value="3"></i><b>(3)</b>
       -v /var/run/docker.sock:/var/run/docker.sock <i class="conum" data-value="4"></i><b>(4)</b>
       -v /usr/lib/x86_64-linux-gnu/libapparmor.so.1:/lib/x86_64-linux-gnu/libapparmor.so.1 <i class="conum" data-value="5"></i><b>(5)</b>
       agileek/docker-jenkins <i class="conum" data-value="6"></i><b>(6)</b></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Le container est lancé avec l&#8217;utilisateur courant et le groupe <code>docker</code> pour pouvoir accéder au <code>docker.sock</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Pour éviter les incohérences de chemin, le chemin racine du jenkins est le même en dehors et dans le container</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Le binaire docker du système est fourni dans l&#8217;image</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Le socket docker est également fourni pour que le client puisse "parler" au démon</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>La bibliotheque apparmor est nécessaire pour le bon fonctionnement de docker client</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="jenkins-workflow-plugin">Jenkins workflow plugin</h3>
<div class="paragraph">
<p>Pour utiliser la suite des éléments, vous aurez besoin des plugins gérant la notion de <em>workflow</em> dans Jenkins :</p>
</div>
<div class="paragraph">
<p><div style="text-align : center">
<a style="display: inline" href="/images/posts/2016-01-JenkinsWorkflow/Workflow-Plugin.png" data-lightbox="0" title="Plugin workflow">
        <img class="medium" src="/images/posts/2016-01-JenkinsWorkflow/Workflow-Plugin_min.png" alt="Plugin workflow"/>
</a>
</div>
<br/></p>
</div>
<div class="paragraph">
<p>Ensuite, il nous est possible de créer un job de construction de type <em>workflow</em> :</p>
</div>
<div class="paragraph">
<p><div style="text-align : center">
<a style="display: inline" href="/images/posts/2016-01-JenkinsWorkflow/Workflow-Plugin_JobCreation.png" data-lightbox="0" title="Création de job">
        <img class="medium" src="/images/posts/2016-01-JenkinsWorkflow/Workflow-Plugin_JobCreation_min.png" alt="Création de job"/>
</a>
</div>
<br/></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="premier-job-em-workflow-em">Premier job <em>Workflow</em></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Ensuite, c&#8217;est là que la magie opère, plutôt que de devoir sélectionner les n-items voulus et remplir chaque étape du build, nous pouvons maintenant le décrire en utilisant du code !
Ainsi, en copiant/collant le script suivant dans la partie idoine, vous devriez avoir un job bien configuré qui marche, du premier coup !</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-kt">def</span> <span class="tok-n">m2Repo</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;-v /var/jenkins_home/.m2:/home/jenkins/.m2&#39;</span> <span class="tok-c1">//  </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-kt">def</span> <span class="tok-n">timezone</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;-e TZ=Europe/Paris&#39;</span> <span class="tok-c1">// </span><i class="conum" data-value="2"></i><b>(2)</b>
<span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-na">image</span><span class="tok-o">(</span><span class="tok-s2">&quot;codetroopers/jenkins-slave-jdk8-restx&quot;</span><span class="tok-o">)</span>
    <span class="tok-o">.</span><span class="tok-na">inside</span><span class="tok-o">(</span><span class="tok-s2">&quot;${m2Repo} ${timezone}&quot;</span><span class="tok-o">){</span> <span class="tok-c1">//  </span><i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">git</span> <span class="tok-nl">branch:</span> <span class="tok-s1">&#39;master&#39;</span><span class="tok-o">,</span> <span class="tok-nl">url:</span> <span class="tok-s1">&#39;https://github.com/code-troopers/jenkins-workflow-demo-repo.git&#39;</span> <span class="tok-c1">// </span><i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-n">sh</span> <span class="tok-s2">&quot;MAVEN_OPTS=-Dfile.encoding=UTF-8 mvn clean install -B -Ppackage&quot;</span> <span class="tok-c1">// </span><i class="conum" data-value="5"></i><b>(5)</b>
    <span class="tok-n">step</span><span class="tok-o">([</span><span class="tok-n">$class</span><span class="tok-o">:</span> <span class="tok-s1">&#39;ArtifactArchiver&#39;</span><span class="tok-o">,</span> <span class="tok-nl">artifacts:</span> <span class="tok-s1">&#39;srv/target/dependency/webapp-runner.jar, srv/target/*.war, run.sh&#39;</span><span class="tok-o">])</span> <span class="tok-c1">// </span><i class="conum" data-value="6"></i><b>(6)</b>
    <span class="tok-n">step</span><span class="tok-o">([</span><span class="tok-n">$class</span><span class="tok-o">:</span> <span class="tok-s1">&#39;JUnitResultArchiver&#39;</span><span class="tok-o">,</span> <span class="tok-nl">testResults:</span> <span class="tok-s1">&#39;**/target/surefire-reports/TEST-*.xml&#39;</span><span class="tok-o">])</span> <span class="tok-c1">// </span><i class="conum" data-value="7"></i><b>(7)</b>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Partage du dépôt Maven local (pour gagner en temps de build)</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Export de la timezone (pour les tests unitaires de l&#8217;exemple)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Démarrage du conteneur de build avec la bonne timezone ainsi que le dépôt partagé</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Clonage des sources</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Lancement du build (en forçant l&#8217;UTF-8)</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>Archivage des produits du build</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Archivage des résultats des tests</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Comme vous pouvez le voir, le script est relativement parlant et permet en plus de s&#8217;affranchir du clickodrome de configuration dans l&#8217;interface de Jenkins !</p>
</div>
<div class="paragraph">
<p>Il est intéressant de noter que l&#8217;image Docker qui sert au build est une image personnalisée. Ce n&#8217;est pas parce qu&#8217;elle inclut un quelconque fonctionnement permettant de builder
en utilisant le plugin Workflow. Elle sert de base uniquement car elle met à disposition la partie <code>npm</code> nécessaire au build de la partie <em>frontend</em> de l&#8217;application RestX.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="grouper-les-étapes">Grouper les étapes</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Le plugin workflow permet en plus de grouper les différentes étapes d&#8217;un build pour permettre, par exemple, de le lancer sur plusieurs environnement différents.
Ici nous ajoutons simplement un nom de groupe pour notre étape de build.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">stage</span> <span class="tok-s1">&#39;build&#39;</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-kt">def</span> <span class="tok-n">m2Repo</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;-v /var/jenkins_home/.m2:/home/jenkins/.m2&#39;</span>
    <span class="tok-kt">def</span> <span class="tok-n">timezone</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;-e TZ=Europe/Paris&#39;</span>
    <span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-na">image</span><span class="tok-o">(</span><span class="tok-s2">&quot;codetroopers/jenkins-slave-jdk8-restx&quot;</span><span class="tok-o">).</span><span class="tok-na">inside</span><span class="tok-o">(</span><span class="tok-s2">&quot;${m2Repo} ${timezone}&quot;</span><span class="tok-o">){</span>
        <span class="tok-n">git</span> <span class="tok-nl">branch:</span> <span class="tok-s1">&#39;master&#39;</span><span class="tok-o">,</span> <span class="tok-nl">url:</span> <span class="tok-s1">&#39;https://github.com/code-troopers/jenkins-workflow-demo-repo.git&#39;</span>
        <span class="tok-n">sh</span> <span class="tok-s2">&quot;MAVEN_OPTS=-Dfile.encoding=UTF-8 mvn clean install -B -Ppackage&quot;</span>
        <span class="tok-n">step</span><span class="tok-o">([</span><span class="tok-n">$class</span><span class="tok-o">:</span> <span class="tok-s1">&#39;ArtifactArchiver&#39;</span><span class="tok-o">,</span> <span class="tok-nl">artifacts:</span> <span class="tok-s1">&#39;srv/target/dependency/webapp-runner.jar, srv/target/*.war, run.sh&#39;</span><span class="tok-o">])</span>
        <span class="tok-n">step</span><span class="tok-o">([</span><span class="tok-n">$class</span><span class="tok-o">:</span> <span class="tok-s1">&#39;JUnitResultArchiver&#39;</span><span class="tok-o">,</span> <span class="tok-nl">testResults:</span> <span class="tok-s1">&#39;**/target/surefire-reports/TEST-*.xml&#39;</span><span class="tok-o">])</span>
    <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Étape nommée pour l&#8217;exécution de la construction de l&#8217;application</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="mettre-de-côté-les-fichiers-pour-plus-tard">Mettre de côté les fichiers pour plus tard</h2>
<div class="sectionbody">
<div class="paragraph">
<p>La notion de <em>stash</em> bien connue des utilisateurs de git est également présente.
Elle permet de mettre de côté des fichiers pour les réutiliser à une étape ultérieure du <em>workflow</em> de build.
Ceci permet d&#8217;éviter l&#8217;archivage de produits du build pour des raisons "techniques".</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">stage</span> <span class="tok-s1">&#39;build&#39;</span>
    <span class="tok-kt">def</span> <span class="tok-n">m2Repo</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;-v /var/jenkins_home/.m2:/home/jenkins/.m2&#39;</span>
    <span class="tok-kt">def</span> <span class="tok-n">timezone</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;-e TZ=Europe/Paris&#39;</span>
    <span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-na">image</span><span class="tok-o">(</span><span class="tok-s2">&quot;codetroopers/jenkins-slave-jdk8-restx&quot;</span><span class="tok-o">).</span><span class="tok-na">inside</span><span class="tok-o">(</span><span class="tok-s2">&quot;${m2Repo} ${timezone}&quot;</span><span class="tok-o">){</span>
        <span class="tok-n">git</span> <span class="tok-nl">branch:</span> <span class="tok-s1">&#39;master&#39;</span><span class="tok-o">,</span> <span class="tok-nl">url:</span> <span class="tok-s1">&#39;https://github.com/code-troopers/jenkins-workflow-demo-repo.git&#39;</span>
        <span class="tok-n">sh</span> <span class="tok-s2">&quot;MAVEN_OPTS=-Dfile.encoding=UTF-8 mvn clean install -B -Ppackage&quot;</span>
        <span class="tok-n">step</span><span class="tok-o">([</span><span class="tok-n">$class</span><span class="tok-o">:</span> <span class="tok-s1">&#39;ArtifactArchiver&#39;</span><span class="tok-o">,</span> <span class="tok-nl">artifacts:</span> <span class="tok-s1">&#39;srv/target/dependency/webapp-runner.jar, srv/target/*.war, run.sh&#39;</span><span class="tok-o">])</span>
        <span class="tok-n">step</span><span class="tok-o">([</span><span class="tok-n">$class</span><span class="tok-o">:</span> <span class="tok-s1">&#39;JUnitResultArchiver&#39;</span><span class="tok-o">,</span> <span class="tok-nl">testResults:</span> <span class="tok-s1">&#39;**/target/surefire-reports/TEST-*.xml&#39;</span><span class="tok-o">])</span>
        <span class="tok-n">stash</span> <span class="tok-nl">includes:</span> <span class="tok-s1">&#39;run.sh,srv/target/dependency/webapp-runner.jar,srv/target/*.war,Dockerfile&#39;</span><span class="tok-o">,</span> <span class="tok-nl">name:</span> <span class="tok-s1">&#39;dockerBuild&#39;</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>
    <span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Enregistrement d&#8217;une liste de fichiers associée à un nom pour une utilisation ultérieure</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="Étape-de-construction-d-une-image-docker">Étape de construction d&#8217;une image Docker</h2>
<div class="sectionbody">
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">stage</span> <span class="tok-s1">&#39;docker&#39;</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>
<span class="tok-n">node</span><span class="tok-o">{</span> <span class="tok-c1">// </span><i class="conum" data-value="2"></i><b>(2)</b>
  <span class="tok-n">ws</span><span class="tok-o">{</span> <span class="tok-c1">// </span><i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-n">unstash</span> <span class="tok-s1">&#39;dockerBuild&#39;</span> <span class="tok-c1">// </span><i class="conum" data-value="4"></i><b>(4)</b>
    <span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">(</span><span class="tok-s2">&quot;codetroopers/jenkins-workflow-demo:${env.BUILD_ID}&quot;</span><span class="tok-o">)</span> <span class="tok-c1">// </span><i class="conum" data-value="5"></i><b>(5)</b>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Création d&#8217;une nouvelle étape</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Permet de distinguer un ensemble d&#8217;opération de build (peut accepter les labels pour restreindre sur des noeuds)</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Déclenche la création d&#8217;un nouveau <em>workspace</em></td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>Récupère les fichiers mis de côté sous le nom <code>dockerBuild</code></td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Construction d&#8217;une image docker avec pour tag le numéro de build en cours (<code>$BUILD_ID</code>)</td>
</tr>
</table>
</div>
</div>
</div>
<div class="sect1">
<h2 id="workflow-et-gestion-multibranche">Workflow et gestion multibranche</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Dans nos façons de fonctionner qui sont maintenant devenues habituelles, nous utilisons de façon intensives les branches pour isoler nos développements.
Un des points fastidieux est de configurer un nouveau job Jenkins pour chaque branche afin de valider son bon fonctionnement et ne pas se rendre compte trop tard d&#8217;un build au rouge.</p>
</div>
<div class="paragraph">
<p>Le plugin 'Workflow Multibranch' simplifie de façon drastique ce genre de cas, il suffit de rajouter un descripteur de build dans les sources.
Le fichier correspondant est tout simplement appelé <code>Jenkinsfile</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">stage</span> <span class="tok-s1">&#39;build&#39;</span>
    <span class="tok-kt">def</span> <span class="tok-n">m2Repo</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;-v /var/jenkins_home/.m2:/home/jenkins/.m2&#39;</span>
    <span class="tok-kt">def</span> <span class="tok-n">timezone</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;-e TZ=Europe/Paris&#39;</span>
    <span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-na">image</span><span class="tok-o">(</span><span class="tok-s2">&quot;codetroopers/jenkins-slave-jdk8-restx&quot;</span><span class="tok-o">).</span><span class="tok-na">inside</span><span class="tok-o">(</span><span class="tok-s2">&quot;${m2Repo} ${timezone}&quot;</span><span class="tok-o">){</span>
        <span class="tok-n">checkout</span> <span class="tok-n">scm</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">sh</span> <span class="tok-s2">&quot;MAVEN_OPTS=-Dfile.encoding=UTF-8 mvn clean install -B -Ppackage&quot;</span>
        <span class="tok-n">step</span><span class="tok-o">([</span><span class="tok-n">$class</span><span class="tok-o">:</span> <span class="tok-s1">&#39;ArtifactArchiver&#39;</span><span class="tok-o">,</span> <span class="tok-nl">artifacts:</span> <span class="tok-s1">&#39;srv/target/dependency/webapp-runner.jar, srv/target/*.war, run.sh&#39;</span><span class="tok-o">])</span>
        <span class="tok-n">step</span><span class="tok-o">([</span><span class="tok-n">$class</span><span class="tok-o">:</span> <span class="tok-s1">&#39;JUnitResultArchiver&#39;</span><span class="tok-o">,</span> <span class="tok-nl">testResults:</span> <span class="tok-s1">&#39;**/target/surefire-reports/TEST-*.xml&#39;</span><span class="tok-o">])</span>
        <span class="tok-n">stash</span> <span class="tok-nl">includes:</span> <span class="tok-s1">&#39;run.sh,srv/target/dependency/webapp-runner.jar,srv/target/*.war,Dockerfile&#39;</span><span class="tok-o">,</span> <span class="tok-nl">name:</span> <span class="tok-s1">&#39;dockerBuild&#39;</span>
    <span class="tok-o">}</span>

<span class="tok-n">stage</span> <span class="tok-s1">&#39;docker&#39;</span>
<span class="tok-n">node</span><span class="tok-o">{</span>
  <span class="tok-n">ws</span><span class="tok-o">{</span>
    <span class="tok-n">unstash</span> <span class="tok-s1">&#39;dockerBuild&#39;</span>
    <span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">(</span><span class="tok-s2">&quot;codetroopers/jenkins-workflow-demo:${env.BUILD_ID}&quot;</span><span class="tok-o">)</span>
  <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Il faut bien entendu remplacer l&#8217;endroit où nous faisions le git clone pour qu&#8217;il soit dynamique par rapport à ce qu&#8217;on
construit. Le terme <code>checkout scm</code> permet de s&#8217;assurer de ce fonctionnement.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>L&#8217;intérêt est que chaque branche qui sera buildée n&#8217;aura pas son historique mélangé avec une autre (là où les jobs de validation de Pull Request ont tendance à tout mélanger).
De plus, un changement dans le process de build sera directement versionné.
Il n&#8217;y aura donc pas besoin de penser à éditer le job lors du merge sur <code>master</code> (on a tous vécu ce genre de situation énervante) !</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="attendre-une-confirmation-utilisateur">Attendre une confirmation utilisateur</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Un des points intéressant de ce plugin est qu&#8217;il permet la mise en pause des constructions.
Ainsi, il est possible de mettre en pause une construction correspondant à une livraison et de lui faire attendre une validation manuelle par exemple.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="pygments highlight"><code data-lang="groovy"><span class="tok-n">stage</span> <span class="tok-s1">&#39;build&#39;</span>
    <span class="tok-kt">def</span> <span class="tok-n">m2Repo</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;-v /var/jenkins_home/.m2:/home/jenkins/.m2&#39;</span>
    <span class="tok-kt">def</span> <span class="tok-n">timezone</span> <span class="tok-o">=</span> <span class="tok-s1">&#39;-e TZ=Europe/Paris&#39;</span>
    <span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-na">image</span><span class="tok-o">(</span><span class="tok-s2">&quot;codetroopers/jenkins-slave-jdk8-restx&quot;</span><span class="tok-o">).</span><span class="tok-na">inside</span><span class="tok-o">(</span><span class="tok-s2">&quot;${m2Repo} ${timezone}&quot;</span><span class="tok-o">){</span>
        <span class="tok-n">git</span> <span class="tok-nl">branch:</span> <span class="tok-s1">&#39;master&#39;</span><span class="tok-o">,</span> <span class="tok-nl">url:</span> <span class="tok-s1">&#39;https://github.com/code-troopers/jenkins-workflow-demo-repo.git&#39;</span>
        <span class="tok-n">sh</span> <span class="tok-s2">&quot;MAVEN_OPTS=-Dfile.encoding=UTF-8 mvn clean install -B -Ppackage&quot;</span>
        <span class="tok-n">step</span><span class="tok-o">([</span><span class="tok-n">$class</span><span class="tok-o">:</span> <span class="tok-s1">&#39;ArtifactArchiver&#39;</span><span class="tok-o">,</span> <span class="tok-nl">artifacts:</span> <span class="tok-s1">&#39;srv/target/dependency/webapp-runner.jar, srv/target/*.war, run.sh&#39;</span><span class="tok-o">])</span>
        <span class="tok-n">step</span><span class="tok-o">([</span><span class="tok-n">$class</span><span class="tok-o">:</span> <span class="tok-s1">&#39;JUnitResultArchiver&#39;</span><span class="tok-o">,</span> <span class="tok-nl">testResults:</span> <span class="tok-s1">&#39;**/target/surefire-reports/TEST-*.xml&#39;</span><span class="tok-o">])</span>
        <span class="tok-n">stash</span> <span class="tok-nl">includes:</span> <span class="tok-s1">&#39;run.sh,srv/target/dependency/webapp-runner.jar,srv/target/*.war,Dockerfile&#39;</span><span class="tok-o">,</span> <span class="tok-nl">name:</span> <span class="tok-s1">&#39;dockerBuild&#39;</span>
    <span class="tok-o">}</span>

<span class="tok-n">stage</span> <span class="tok-s1">&#39;docker&#39;</span>
<span class="tok-n">node</span><span class="tok-o">{</span>
    <span class="tok-n">ws</span><span class="tok-o">{</span>
        <span class="tok-n">unstash</span> <span class="tok-s1">&#39;dockerBuild&#39;</span>
        <span class="tok-kt">def</span> <span class="tok-n">built</span> <span class="tok-o">=</span> <span class="tok-n">docker</span><span class="tok-o">.</span><span class="tok-na">build</span><span class="tok-o">(</span><span class="tok-s2">&quot;codetroopers/jenkins-workflow-demo:${env.BUILD_ID}&quot;</span><span class="tok-o">)</span>
        <span class="tok-n">input</span> <span class="tok-s1">&#39;Is everything ok ? Run app ?&#39;</span> <span class="tok-c1">// </span><i class="conum" data-value="1"></i><b>(1)</b>
        <span class="tok-n">echo</span> <span class="tok-s2">&quot;We can run the docker-compose up here&quot;</span>
        <span class="tok-kt">def</span> <span class="tok-n">outcome</span> <span class="tok-o">=</span> <span class="tok-n">input</span> <span class="tok-nl">message:</span> <span class="tok-s1">&#39;We can even have parameters to answer this question&#39;</span><span class="tok-o">,</span> <span class="tok-nl">parameters:</span> <span class="tok-o">[</span> <span class="tok-c1">// </span><i class="conum" data-value="2"></i><b>(2)</b>
            <span class="tok-o">[</span><span class="tok-nl">name:</span> <span class="tok-s1">&#39;myChoice&#39;</span><span class="tok-o">,</span> <span class="tok-nl">description:</span> <span class="tok-s1">&#39;My choice&#39;</span><span class="tok-o">,</span> <span class="tok-nl">choices:</span> <span class="tok-s1">&#39;Choice 1\nChoice 2\nChoice 3&#39;</span><span class="tok-o">,</span> <span class="tok-n">$class</span><span class="tok-o">:</span> <span class="tok-s1">&#39;ChoiceParameterDefinition&#39;</span><span class="tok-o">]</span>
        <span class="tok-o">]</span>
        <span class="tok-n">echo</span> <span class="tok-s2">&quot;You have chosen ${outcome}&quot;</span> <span class="tok-c1">// </span><i class="conum" data-value="3"></i><b>(3)</b>
    <span class="tok-o">}</span>
<span class="tok-o">}</span></code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td><code>input</code> met en pause la construction et permet de continuer ou interrompre celle-ci</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Il est également possible de permettre à l&#8217;utilisateur de faire un choix</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Ici la valeur sélectionnée par l&#8217;utilisateur est écrite dans la sortie du build.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p><em>J&#8217;espère que cet article vous donnera l&#8217;envie d&#8217;essayer de rationnaliser un peu plus la configuration de vos job Jenkins en les stockant dans votre SCM</em></p>
</div>
</div>
</div>
                </div>
<div class="share">
L'article vous a plu ? Partagez-le :
    <ul class="socials">
        <li>
            <a target="_blank" title="Twitter" href="https://twitter.com/share?url=http://code-troopers.com/2016/01/20/JenkinsWorkflow.html&text=Jenkins Workflow Plugin&via=codetroopers" 
                rel="nofollow" 
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=400,width=700');return false;">
                <i class="fa fa-twitter-square"></i>
            </a>
        </li>
        <li>
            <a target="_blank" title="Facebook" href="https://www.facebook.com/sharer.php?u=http://code-troopers.com/2016/01/20/JenkinsWorkflow.html&t=Jenkins Workflow Plugin" 
                class="facebook-button" rel="nofollow" 
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=500,width=700');return false;">
                <i class="fa fa-facebook-square"></i>
            </a>
        </li>
        <li>
            <a target="_blank" title="Google +" href="https://plus.google.com/share?url=http://code-troopers.com/2016/01/20/JenkinsWorkflow.html&hl=fr" 
                class="google-button" rel="nofollow" 
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;">
                <i class="fa fa-google-plus-square"></i>
            </a>
        </li>
        <li>
            <a target="_blank" title="Linkedin" href="https://www.linkedin.com/shareArticle?mini=true&url=http://code-troopers.com/2016/01/20/JenkinsWorkflow.html&title=Jenkins Workflow Plugin" 
                class="linkedin-button" rel="nofollow" 
                onclick="javascript:window.open(this.href, '', 'menubar=no,toolbar=no,resizable=yes,scrollbars=yes,height=450,width=650');return false;">
                <i class="fa fa-linkedin-square"></i>
            </a>
        </li>
        <li>
            <a target="_blank" title="Envoyer par mail" href="mailto:?subject=Jenkins Workflow Plugin&body=http://code-troopers.com/2016/01/20/JenkinsWorkflow.html" rel="nofollow">
                <i class="fa fa-envelope"></i>
            </a>
        </li>
    </ul>
</div>
<div style="clear:both"></div>



                <div class="back">
                    <a href="/blog/index.html"><i class="fa fa-arrow-circle-o-up"></i> Retour aux articles</a>
                    <div class="pull-right paginate">
                        
                        <a href="/2016/01/14/StartupWeekend-CotePerdant.html"><i class="fa fa-arrow-circle-o-left"></i> Précédent</a>
                        
                        
                        <a href="/2016/03/30/Android_Google_Tag_Manager_Feature_Toggle.html"><i class="fa fa-arrow-circle-o-right"></i> Suivant</a>
                        
                    </div>
                </div>
                <div id="disqus_thread"></div>
                <script type="text/javascript">
                    /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
                    var disqus_shortname = 'codetroopers'; // required: replace example with your forum shortname
		    var disqus_url = window.location.href;
		    if (window.location.protocol != "http:"){
			disqus_url = "http:" + window.location.href.substring(window.location.protocol.length);
		    }

                    /* * * DON'T EDIT BELOW THIS LINE * * */
                    (function() {
                        var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                        dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
                        (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                    })();
                </script>
                <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
                <a href="http://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>

            </div>
        </article>
        </div>
    </section>
<footer id="contact">
    <div class="container">
        <div class="row">
            <div class="col-md-6" itemscope itemtype="http://schema.org/Organization">
                <h3>Contact</h3>

                <p>Vous avez besoin de nous pour un projet, contactez-nous sur les réseaux sociaux, par mail à <a
                    href="mailto:contact@code-troopers.com"><meta itemprop="email" content="contact@code-troopers.com">contact@code-
                    troopers.com</a> ou par téléphone au <a href="tel:+33782287216"><span itemprop="telephone">0782 287 216</span></a></p>
            </div>
            <div class="col-md-6 simple-social-icons">
                <h3>Réseaux sociaux</h3>
                <ul class="socials">
                    <li><a target="_blank" href="https://twitter.com/codetroopers"><i
                            class="fa fa-twitter-square"></i></a></li>
                    <li><a target="_blank"
                           href="https://www.facebook.com/pages/Code-Troopers/123604307824664"><i
                            class="fa fa-facebook-square"></i></a></li>
                    <li><a target="_blank" href="https://plus.google.com/+Code-troopers" rel="publisher"><i
                            class="fa fa-google-plus-square"></i></a></li>
                    <li><a target="_blank" href="https://github.com/code-troopers"><i
                            class="fa fa-github-square"></i></a></li>
                    <li><a target="_blank" href="/feed.xml"><i
                            class="fa fa-rss-square"></i></a></li>
                </ul>
            </div>
        </div>
        <div class="row">
            <div class="footer-under">
                Made with <i class="fa fa-heart"></i> in Tours -
              © 2016 Code-Troopers - Tous droits réservés
            </div>
						<div class="legals footer-under">
							  Mentions légales : <br>
							  Code-Troopers est une  marque déposée à l'INPI (numéro 4145181).<br>
								CT-CDGT SARL au capital de 1000€, 73 rue Ledru Rollin, 37000 Tours, 808 881 064 RCS Tours. <br>
								Site hébergé par GitHub Inc.
						</div>
        </div>
    </div>
</footer>

<script src="/js/scripts-b19cf21e7d.js"></script>

</body>
</html>



